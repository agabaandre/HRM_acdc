openapi: 3.0.3
info:
  title: APM (Approvals Management) API
  description: |
    REST API for the Approvals Management module. Used by approver apps to list pending approvals,
    view documents, perform actions (approve/reject/return/cancel), and access memo lists.
    Authentication is JWT (Bearer token). API users are synced from the staff app `user` table;
    password verification supports Argon2i hashes.
  version: 1.0.0
  contact:
    name: APM Support

servers:
  - url: "{{API_BASE_URL}}"
    description: API base URL for this server (injected from the host where the docs are loaded)
  - url: "{{APP_BASE_URL}}"
    description: Web app root (for document verification upload; use when calling POST /api/documents/verify)

tags:
  - name: Auth
    description: JWT login, refresh, logout, me
  - name: Pending
    description: Pending approvals for current user
  - name: Documents
    description: Document detail by type and id (with approval trails)
  - name: Actions
    description: Approve, reject, return, cancel on documents
  - name: Approved by me
    description: List and average time for documents approved by current user
  - name: Matrices
    description: Matrix detail and approve/return
  - name: Activities
    description: Activity detail and pass/return/convert
  - name: Memo list
    description: Division memo list (pending or approved) with filters
  - name: Reference data
    description: Lookup data (divisions, staff, fund codes, workflow definitions, etc.)
  - name: Document verification
    description: Verify APM document signature hashes via PDF upload (PDF only; session auth)

paths:
  /api/documents/verify:
    post:
      tags: [Document verification]
      summary: Verify document via PDF upload
      description: |
        Upload an APM-generated PDF to extract document number and signature hashes and validate them against the system.
        **PDF only**; max 10MB. File is not stored. Uses session (cookie) authenticationâ€”call from the web app or send the app session cookie.
        Use server "Web app root" (APP_BASE_URL) for this endpoint.
      operationId: documentsVerifyUpload
      security: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [document]
              properties:
                document:
                  type: string
                  format: binary
                  description: APM PDF document (PDF only; max 10MB)
      responses:
        '200':
          description: Verification result (extracted document numbers, hashes, and whether they matched system signatories)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  result_type: { type: string, example: upload_validation }
                  document:
                    type: object
                    properties:
                      document_number: { type: string, nullable: true }
                      doc_type: { type: string, nullable: true }
                      metadata: { type: object }
                  signatories: { type: array, items: { type: object } }
                  valid: { type: boolean, description: true if at least one extracted hash matched a signatory }
                  extracted_document_numbers: { type: array, items: { type: string } }
                  extracted_hashes: { type: array, items: { type: string } }
                  hash_validations:
                    type: array
                    items:
                      type: object
                      properties:
                        hash: { type: string }
                        matched: { type: boolean }
                        signatory: { type: object, nullable: true }
                  documents: { type: array, description: List of matched documents with document_number, doc_type, metadata }
        '422':
          description: Validation error (e.g. file missing, not PDF, or too large)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "Only PDF files are accepted." }
                  errors: { type: object }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login
      security: []
      description: Authenticate with email and password. Returns JWT and user data. Passwords use Argon2i (same as staff app).
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      access_token: { type: string }
                      token_type: { type: string, example: bearer }
                      expires_in: { type: integer, description: seconds }
                      user:
                        type: object
                        properties:
                          user_id: { type: integer }
                          auth_staff_id: { type: integer }
                          email: { type: string }
                          name: { type: string }
                          division_id: { type: integer, nullable: true }
                          role: { type: string }
                          status: { type: boolean }
        '422':
          description: Validation or invalid credentials

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh token
      description: Return a new JWT. Requires valid Bearer token.
      operationId: refresh
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: New token and user
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    properties:
                      access_token: { type: string }
                      token_type: { type: string }
                      expires_in: { type: integer }
                      user: { $ref: '#/components/schemas/UserData' }
        '401':
          description: Unauthorized

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout
      operationId: logout
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: Success

  /auth/me:
    get:
      tags: [Auth]
      summary: Current user
      description: Returns authenticated user data (no token).
      operationId: me
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: User data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  data: { $ref: '#/components/schemas/UserData' }
        '401':
          description: Unauthorized

  /pending-approvals:
    get:
      tags: [Pending]
      summary: Pending approvals (memos with approval trails)
      description: |
        List of documents pending the current user's action, grouped by category (Matrix, Special Memo, etc.).
        Each item includes approval_trails: the full history of who approved/returned/rejected and when.
        Use this to show pending memos with their approval trail; use GET /documents/{type}/{id} for full document detail.
      operationId: pendingApprovals
      security: [{ bearerAuth: [] }]
      parameters:
        - name: category
          in: query
          schema: { type: string, example: all }
          description: Filter by category (e.g. Matrix, Special Memo) or "all"
      responses:
        '200':
          description: Pending items (each with approval_trails) and summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    properties:
                      pending:
                        type: object
                        description: Keys are category names (e.g. "Special Memo", "Matrix"); values are arrays of pending items, each with approval_trails.
                        additionalProperties:
                          type: array
                          items: { $ref: '#/components/schemas/PendingApprovalItem' }
                      summary: { type: object, description: total_pending, by_category, by_division, oldest_pending, newest_pending }
                      filters: { type: object }

  /pending-approvals/summary:
    get:
      tags: [Pending]
      summary: Pending summary
      description: Summary counts only (no item list).
      operationId: pendingSummary
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: Summary stats

  /documents/{type}/{status}:
    get:
      tags: [Documents]
      summary: List documents by type and status
      description: |
        Returns all documents of the given type with the given overall_status (from mother models).
        Optional query parameter **id** returns a single document when provided.
        When listing (no id), results are ordered **latest first** (year desc, quarter desc, created_at desc)
        and support memo-list style filters and pagination.
        Each document includes approval_trails and attachments (with url for download).
      operationId: listDocumentsByTypeAndStatus
      security: [{ bearerAuth: [] }]
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
            enum: [special_memo, matrix, activity, non_travel_memo, service_request, arf, change_request]
        - name: status
          in: path
          required: true
          schema:
            type: string
            enum: [pending, approved, draft, rejected, returned]
        - name: id
          in: query
          required: false
          schema: { type: integer }
          description: If provided, return only this document (must match type and status).
        - name: year
          in: query
          required: false
          schema: { type: string }
          description: Filter by year (matrix/activity use matrix year; others use created_at year).
        - name: quarter
          in: query
          required: false
          schema: { type: string, enum: [Q1, Q2, Q3, Q4] }
          description: Filter by quarter (matrix/activity use matrix quarter; others use QUARTER(created_at)).
        - name: title
          in: query
          required: false
          schema: { type: string }
          description: Search in title/activity_title (LIKE %value%). Service request uses title and service_title.
        - name: document_number
          in: query
          required: false
          schema: { type: string }
          description: Search in document_number (LIKE %value%).
        - name: per_page
          in: query
          required: false
          schema: { type: integer, default: 20, minimum: 1, maximum: 100 }
          description: Number of items per page (list only).
        - name: page
          in: query
          required: false
          schema: { type: integer, default: 1, minimum: 1 }
          description: Page number (list only).
      responses:
        '200':
          description: List of documents or single document (when id provided).
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    description: Single document when id query param is provided.
                    properties:
                      success: { type: boolean }
                      data:
                        type: object
                        description: One document with document_type, approval_trails, attachments.
                  - type: object
                    description: List when id is not provided (paginated, latest first).
                    properties:
                      success: { type: boolean }
                      data: { type: array, items: { type: object } }
                      count: { type: integer, description: Items in this page }
                      total: { type: integer, description: Total items matching filters }
                      per_page: { type: integer }
                      current_page: { type: integer }
                      last_page: { type: integer }
                      filters:
                        type: object
                        description: Echo of applied filter query params (year, quarter, title, document_number).
                        properties:
                          year: { type: string, nullable: true }
                          quarter: { type: string, nullable: true }
                          title: { type: string, nullable: true }
                          document_number: { type: string, nullable: true }
        '404':
          description: Document not found or status mismatch

  /documents/{type}/{id}:
    get:
      tags: [Documents]
      summary: Get document by id
      description: |
        Single document by type and id (regardless of status). Includes approval_trails and attachments.
        Each attachment has a url that can be used to download the file (GET with same Bearer token).
        For listing by status use GET /documents/{type}/{status}.
      operationId: getDocument
      security: [{ bearerAuth: [] }]
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
            enum: [special_memo, matrix, activity, non_travel_memo, service_request, arf, change_request]
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Document with approval_trails and attachments (each with url)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    properties:
                      document_type: { type: string }
                      approval_trails:
                        type: array
                        items: { $ref: '#/components/schemas/ApprovalTrailItem' }
                      attachments:
                        type: array
                        description: Attachments with url for API download (GET /documents/attachments/{type}/{id}/{index})
                        items: { $ref: '#/components/schemas/DocumentAttachmentItem' }
        '404':
          description: Document not found

  /documents/attachments/{type}/{id}/{index}:
    get:
      tags: [Documents]
      summary: Download document attachment
      description: |
        Stream a single attachment file by document type, id, and zero-based index.
        Use the url from GET /documents/{type}/{id} response (attachments[].url).
        Requires same Bearer token. Returns the file with Content-Disposition inline and original filename.
      operationId: getDocumentAttachment
      security: [{ bearerAuth: [] }]
      parameters:
        - name: type
          in: path
          required: true
          schema:
            type: string
            enum: [special_memo, matrix, activity, non_travel_memo, service_request, arf, change_request]
        - name: id
          in: path
          required: true
          schema: { type: integer }
        - name: index
          in: path
          required: true
          schema: { type: integer, minimum: 0 }
          description: Zero-based index of the attachment (matches order in document data.attachments).
      responses:
        '200':
          description: File stream (content-type and filename from attachment metadata).
        '404':
          description: Document or attachment not found
        '400':
          description: Invalid attachment path

  /actions:
    post:
      tags: [Actions]
      summary: Apply action to one document
      description: |
        Submit an approval action for a **single** document (memo, matrix, activity, etc.).
        Does not return the document or approval trails; use GET /documents/{type}/{id} to fetch the updated document with approval_trails after applying an action.
        **Actions:** approved, rejected, returned, cancelled (cancelled = HOD return for special memo only; for other types use "returned").
      operationId: action
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, id, action]
              properties:
                type:
                  type: string
                  enum: [special_memo, non_travel_memo, single_memo, matrix, service_request, arf, change_request]
                  description: Document type (use same as in pending-approvals item_type or documents path).
                id: { type: integer, description: Document ID }
                action:
                  type: string
                  enum: [approved, rejected, returned, cancelled]
                  description: approved, rejected, returned, or cancelled (special memo HOD only).
                comment: { type: string, maxLength: 1000, description: Optional remarks }
                available_budget: { type: number, minimum: 0, description: Optional; for activities with budget }
            example:
              type: special_memo
              id: 19
              action: approved
              comment: "Approved as requested."
      responses:
        '200':
          description: Action applied successfully (fetch document with GET /documents/{type}/{id} for updated approval_trails).
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "Action applied successfully." }
                  data:
                    type: object
                    properties:
                      action: { type: string, example: approved }
                      document_type: { type: string }
                      document_id: { type: integer }
        '403':
          description: Not authorized to perform this action
        '404':
          description: Document not found

  /approved-by-me:
    get:
      tags: [Approved by me]
      summary: Documents approved by me
      description: List of documents the current user has approved/rejected, plus average approval time (same as dashboard).
      operationId: approvedByMe
      security: [{ bearerAuth: [] }]
      parameters:
        - name: year
          in: query
          schema: { type: integer }
        - name: month
          in: query
          schema: { type: integer }
        - name: per_page
          in: query
          schema: { type: integer, default: 20 }
      responses:
        '200':
          description: List and average time
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    properties:
                      documents: { type: array, items: { $ref: '#/components/schemas/ApprovedByMeItem' } }
                      total: { type: integer }
                      average_approval_time_hours: { type: number }
                      average_approval_time_display: { type: string }

  /approved-by-me/average-time:
    get:
      tags: [Approved by me]
      summary: Average approval time
      operationId: averageTime
      security: [{ bearerAuth: [] }]
      parameters:
        - name: year
          in: query
          schema: { type: integer }
        - name: month
          in: query
          schema: { type: integer }
      responses:
        '200':
          description: Average time only

  /matrices/{matrixId}:
    get:
      tags: [Matrices]
      summary: Matrix detail
      description: Matrix with activities and metadata (passed vs pending for current approver).
      operationId: matrixShow
      security: [{ bearerAuth: [] }]
      parameters:
        - name: matrixId
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Matrix and activities
        '404':
          description: Not found
    post:
      tags: [Matrices]
      summary: Matrix approve or return
      operationId: matrixUpdateStatus
      security: [{ bearerAuth: [] }]
      parameters:
        - name: matrixId
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [action]
              properties:
                action: { type: string, enum: [approved, returned] }
                comment: { type: string }
      responses:
        '200':
          description: Success
        '403':
          description: Not current approver

  /matrices/{matrixId}/activities/{activityId}:
    get:
      tags: [Activities]
      summary: Activity detail
      description: Activity (matrix activity or single memo). Same data as matrices/24/activities/401.
      operationId: activityShow
      security: [{ bearerAuth: [] }]
      parameters:
        - name: matrixId
          in: path
          required: true
          schema: { type: integer }
        - name: activityId
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Activity data
        '404':
          description: Not found
    post:
      tags: [Activities]
      summary: Activity action
      description: Pass, return, or convert to single memo (matrix activities only).
      operationId: activityUpdateStatus
      security: [{ bearerAuth: [] }]
      parameters:
        - name: matrixId
          in: path
          required: true
          schema: { type: integer }
        - name: activityId
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [action]
              properties:
                action: { type: string, enum: [passed, returned, convert_to_single_memo] }
                comment: { type: string }
                available_budget: { type: number }
      responses:
        '200':
          description: Success
        '404':
          description: Not found

  /memo-list/pending:
    get:
      tags: [Memo list]
      summary: Pending memos (division)
      description: Pending memos for the authenticated user's division only. Same data shape as reports memo-list.
      operationId: memoListPending
      security: [{ bearerAuth: [] }]
      parameters:
        - name: year
          in: query
          schema: { type: integer }
        - name: quarter
          in: query
          schema: { type: string, enum: [Q1, Q2, Q3, Q4] }
        - name: memo_type
          in: query
          schema: { type: string, enum: [QM, SM, SPM, NT, CR, SR, ARF] }
          description: Document type code
        - name: title
          in: query
          schema: { type: string }
          description: Partial match on title
        - name: document_number
          in: query
          schema: { type: string }
          description: Partial match on document number
        - name: per_page
          in: query
          schema: { type: integer, default: 20 }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
      responses:
        '200':
          description: Paginated pending memos
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    properties:
                      memos: { type: array }
                      division_id: { type: integer, nullable: true }
                      status: { type: string, example: pending }
                      filters: { type: object }
                      total: { type: integer }
                      per_page: { type: integer }
                      current_page: { type: integer }
                      last_page: { type: integer }

  /memo-list/approved:
    get:
      tags: [Memo list]
      summary: Approved memos (division)
      description: Approved memos for the authenticated user's division only. Same filters as pending.
      operationId: memoListApproved
      security: [{ bearerAuth: [] }]
      parameters:
        - name: year
          in: query
          schema: { type: integer }
        - name: quarter
          in: query
          schema: { type: string, enum: [Q1, Q2, Q3, Q4] }
        - name: memo_type
          in: query
          schema: { type: string, enum: [QM, SM, SPM, NT, CR, SR, ARF] }
        - name: title
          in: query
          schema: { type: string }
        - name: document_number
          in: query
          schema: { type: string }
        - name: per_page
          in: query
          schema: { type: integer, default: 20 }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
      responses:
        '200':
          description: Paginated approved memos

  /reference-data:
    get:
      tags: [Reference data]
      summary: Reference / lookup data
      description: |
        Returns divisions, directorates, fund_types, fund_codes, cost_items, staff,
        funders, request_types, non_travel_categories, partners, and workflow_definitions.
        Each workflow_definition includes approvers with id, staff_id, staff_name, oic_staff_id, oic_staff_name.
        Optional query param `include`: comma-separated list of keys to return only those datasets;
        if omitted, all are returned. Allowed keys: divisions, directorates, fund_types, fund_codes,
        cost_items, staff, funders, request_types, non_travel_categories, partners, workflow_definitions.
        Requires Bearer token.
      operationId: referenceData
      security: [{ bearerAuth: [] }]
      parameters:
        - name: include
          in: query
          required: false
          description: Comma-separated list of reference datasets to return (e.g. divisions,staff,fund_types). If omitted, all datasets are returned. Invalid keys are ignored.
          schema:
            type: string
            example: "divisions,staff,fund_types"
      responses:
        '200':
          description: Reference data object
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    properties:
                      divisions: { type: array, items: { type: object, properties: { id: {}, name: {}, short_name: {}, directorate_id: {} } } }
                      directorates: { type: array, items: { type: object, properties: { id: {}, name: {} } } }
                      fund_types: { type: array, items: { type: object, properties: { id: {}, name: {} } } }
                      fund_codes: { type: array, items: { type: object, description: id, code, activity, fund_type_id, funder_id, partner_id, division_id, year, fund_type_name, funder_name, partner_name } }
                      cost_items: { type: array, items: { type: object, properties: { id: {}, name: {}, cost_type: {} } } }
                      staff: { type: array, items: { type: object, properties: { id: {}, name: {}, title: {}, work_email: {}, division_id: {} } } }
                      funders: { type: array, items: { type: object, properties: { id: {}, name: {} } } }
                      request_types: { type: array, items: { type: object, properties: { id: {}, name: {} } } }
                      non_travel_categories: { type: array, items: { type: object, properties: { id: {}, name: {} } } }
                      partners: { type: array, items: { type: object, properties: { id: {}, name: {} } } }
                      workflow_definitions:
                        type: array
                        items:
                          type: object
                          properties:
                            id: { type: integer }
                            workflow_id: { type: integer }
                            workflow_name: { type: string, nullable: true }
                            role: { type: string, nullable: true }
                            approval_order: { type: integer, nullable: true }
                            approvers:
                              type: array
                              items:
                                type: object
                                properties:
                                  id: { type: integer }
                                  staff_id: { type: integer, nullable: true }
                                  staff_name: { type: string, nullable: true }
                                  oic_staff_id: { type: integer, nullable: true }
                                  oic_staff_name: { type: string, nullable: true }
        '401':
          description: Unauthenticated

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT from login or refresh

  schemas:
    UserData:
      type: object
      properties:
        user_id: { type: integer }
        auth_staff_id: { type: integer }
        email: { type: string }
        name: { type: string }
        division_id: { type: integer, nullable: true }
        role: { type: string }
        status: { type: boolean }

    ApprovalTrailItem:
      type: object
      properties:
        id: { type: integer }
        action: { type: string }
        remarks: { type: string, nullable: true }
        approval_order: { type: integer, nullable: true }
        staff_id: { type: integer, nullable: true }
        staff_name: { type: string, nullable: true }
        oic_staff_id: { type: integer, nullable: true }
        oic_staff_name: { type: string, nullable: true }
        role: { type: string, nullable: true }
        created_at: { type: string, format: date-time, nullable: true }
        is_archived: { type: boolean }

    DocumentAttachmentItem:
      type: object
      description: One attachment with API download url.
      properties:
        type: { type: string, nullable: true, description: Attachment type label (e.g. Consultant TOR) }
        filename: { type: string, description: Stored filename }
        original_name: { type: string, description: Original upload filename }
        path: { type: string, description: Internal path (storage) }
        size: { type: integer, description: File size in bytes }
        mime_type: { type: string, description: MIME type }
        uploaded_at: { type: string, format: date-time, nullable: true }
        url:
          type: string
          format: uri
          description: API URL to download this file (GET with Bearer token). Same as GET /documents/attachments/{type}/{id}/{index}.

    PendingApprovalItem:
      type: object
      description: One pending document; includes approval_trails (history of actions).
      properties:
        id: { type: integer }
        category: { type: string }
        type: { type: string, description: "e.g. SpecialMemo, Matrix, Activity" }
        status: { type: string }
        title: { type: string }
        division: { type: string }
        submitted_by: { type: string }
        date_received: { type: string, nullable: true }
        view_url: { type: string }
        approval_level: { type: integer }
        workflow_role: { type: string, nullable: true }
        item_id: { type: integer }
        item_type: { type: string }
        approval_trails:
          type: array
          items: { $ref: '#/components/schemas/ApprovalTrailItem' }
          description: Full approval history for this memo/document.

    ApprovedByMeItem:
      type: object
      properties:
        document_type: { type: string }
        document_id: { type: integer }
        action: { type: string }
        acted_at: { type: string, format: date-time }
        title: { type: string, nullable: true }

security:
  - bearerAuth: []
