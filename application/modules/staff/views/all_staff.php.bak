<style>
	@media print {
		.hidden {
			display: none;
		}

		@page {
			margin-top: 0;
			margin-bottom: 0;
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100%;
			/* html, body{
                height: 100%;
                width: 100%;
            } */
		}

		/* body{
            padding-top: 72px;
            padding-bottom: 72px;
        } */
	}
</style>

<?php $this->load->view('staff_tab_menu'); ?>
<div class="card">
	<div class="card-body">
		
<?= form_open_multipart(base_url('staff/all_staff'), ['id' => 'staff_form', 'class' => 'staff', 'method' => 'get']) ?>

<?php $this->load->view('staff_filters'); ?>

<?= form_close() ?>

<div class="row mb-3 align-items-center">
	<div class="col-md-6">
		<div id="paginationLinksTop" class="d-flex align-items-center"></div>
	</div>
	<div class="col-md-6 text-end">
		<div id="exportButtonsTop" class="d-flex gap-2 justify-content-end">
			<!-- Export buttons will be moved here from staff_filters -->
		</div>
	</div>
</div>

<div class="table-responsive" style="margin-left: 4px; margin-right: 4px;">
	<table class="table table-striped table-bordered">
		<thead>
			<tr>
				<th>#</th>
				<th>SAPNO</th>
				<th>Title</th>
				<th>Passport Photo</th>
				<th>Name</th>
				<th>Gender</th>
				<th>Age</th>
				<th>Nationality</th>
				<th>Duty Station</th>
				<th>Division</th>
				<th>Job</th>
				<th>Acting Job</th>
				<th>First Supervisor</th>
				<th>Second Supervisor</th>
				<th>Funder</th>
				<th>Email</th>
				<th>Telephone</th>
				<th>WhatsApp</th>
			</tr>
		</thead>
		<tbody id="staffTableBody">
			<tr>
				<td colspan="18" class="text-center">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
					<p class="mt-2">Loading staff data...</p>
				</td>
			</tr>
		</tbody>
							<div class="modal-dialog modal-dialog-centered modal-lg">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="add_item_label">Edit Employee Profile: <?= $data->lname . ' ' . $data->fname . ' ' . @$data->oname ?></h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>

									<div class="modal-body">

										<?php echo validation_errors(); ?>
										<?php echo form_open('staff/update_staff'); ?>
										<div class="row">

											<div class="col-md-6">


												<h4>Personal Information</h4>

												<div class="form-group">
													<label for="SAPNO">SAP Number:<?=asterik()?></label>
													<input type="text" class="form-control" value="<?= $data->SAPNO ?>" name="SAPNO" id="SAPNO">
												</div>

												<div class="form-group">
													<label for="gender">Title:<?=asterik()?></label>
													<select class="form-control" name="title" id="title" required>
														<?php if (!empty($data->title)) { ?>
															<option value="<?php echo $data->title ?>"><?php echo $data->title ?></option>
														<?php } ?>
														<option value="">Select Title</option>
														<option value="Dr">Dr</option>
														<option value="Prof">Prof</option>
														<option value="Rev">Rev</option>
														<option value="Mr">Mr</option>
														<option value="Mrs">Mrs</option>
														<option value="Ms">Ms</option>

													</select>
												</div>

												<div class="form-group">
													<label for="fname">First Name:<?=asterik()?></label>
													<input type="text" class="form-control" value="<?php echo $data->fname;   ?>" name="fname" id="fname" required>
												</div>
												<input type="hidden" name="staff_id" value="<?php echo $data->staff_id; ?>">

												<div class="form-group">
													<label for="lname">Last Name:<?=asterik()?></label>
													<input type="text" class="form-control" name="lname" value="<?php echo $data->lname;   ?>" id="lname" required>
												</div>

												<div class="form-group">
													<label for="oname">Other Name:</label>
													<input type="text" class="form-control" value="<?php echo $data->oname;   ?>" name="oname" id="oname">
												</div>

												<div class="form-group">
													<label for="date_of_birth">Date of Birth:<?=asterik()?></label>
													<input type="text" class="form-control datepicker" value="<?php echo $data->date_of_birth; ?>" name="date_of_birth" id="date_of_birth" required>
												</div>

												<div class="form-group">
													<label for="gender">Gender:<?=asterik()?></label>
													<select class="form-control" name="gender" id="gender" required>
														<?php if (!empty($data->gender)) {
															echo $data->gender;
														} ?>
														<option value="Male">Male</option>
														<option value="Female">Female</option>
														<option value="Other">Other</option>
													</select>
												</div>

												<div class="form-group">
													<label for="nationality_id">Nationality:<?=asterik()?></label>
													<select class="form-control select2" name="nationality_id" id="nationality_id" required>
														<?php $lists = Modules::run('lists/nationality');
														foreach ($lists as $list) :
														?>
															<option value="<?php echo $list->nationality_id; ?>" <?php if ($list->nationality_id == $data->nationality_id) {
																														echo "selected";
																													} ?>><?php echo $list->status; ?><?php echo $list->nationality; ?></option>
														<?php endforeach; ?>
														<!-- Add more options as needed -->
													</select>
												</div>

												<div class="form-group">
													<label for="initiation_date">Initiation Date: <?=asterik()?></label>
													<input type="text" class="form-control datepicker" value="<?php echo $data->initiation_date; ?>" name="initiation_date" id="initiation_date" required>
												</div>
											</div>

											<div class="col-md-6">
												<h4>Contact Information</h4>


												<div class="form-group">
													<label for="tel_1">Telephone 1: <?=asterik()?></label>
													<input type="text" class="form-control" value="<?php echo $data->tel_1; ?>" name="tel_1" id="tel_1" required>
												</div>

												<div class="form-group">
													<label for="tel_2">Telephone 2:</label>
													<input type="text" class="form-control" value="<?php echo $data->tel_2; ?>" name="tel_2" id="tel_2">
												</div>

												<div class="form-group">
													<label for="whatsapp">WhatsApp:</label>
													<input type="text" class="form-control" name="whatsapp" value="<?php echo $data->whatsapp; ?>" id="whatsapp">
												</div>

												<div class="form-group">
													<label for="work_email">Work Email:<?=asterik()?></label>
													<input type="email" class="form-control" name="work_email" value="<?php echo $data->work_email; ?>" id="work_email" required>
												</div>
												<br>
												<div class="form-group">
													<label for="private_email">Private Email:</label>
													<input type="email" class="form-control" name="private_email" value="<?php echo $data->private_email; ?>" id="private_email">
												</div>

												<div class="form-group">
													<label for="physical_location">Physical Location:</label>
													<textarea class="form-control" name="physical_location" id="physical_location" rows="2"><?php echo $data->physical_location; ?></textarea>
												</div>
											</div>
										</div>

										<div class="form-group" style="float:right;">
											<br>
											<label for="submit"></label>
											<input type="submit" class="btn btn-dark" value="Save">
										</div>

										<?php echo form_close(); ?>
									</div>
								</div>
							</div>

						</div>
	</div>

</div>

<!-- edit employee data model -->




<!-- edit model -->


<script>
	// Print button functionality
	function printPage() {
		// Hide the print button before printing
		document.querySelector(".btn-print").style.display = "none";

		// Print only the worker's profile
		var printContents = document.getElementById("worker_profile").innerHTML;
		var originalContents = document.body.innerHTML;

		document.body.innerHTML = printContents;
		window.print();

		// Restore the original contents after printing
		document.body.innerHTML = originalContents;

		// Dismiss the modal after printing
		document.getElementById("add_profile").addEventListener("afterprint", function() {
			var modal = new bootstrap.Modal(document.getElementById("add_profile"));
			modal.hide();
		});
	}
</script>




</tr>
<?php endforeach; ?>
		</table>
		<div id="paginationInfo" class="mt-3 text-end">
			<div id="paginationLinks" class="mt-2"></div>
		</div>
	</div>
	</div>
	</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Employee Passport Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" style="width:150px; height:auto; border-radius:10px;">
            </div>
        </div>
    </div>
</div>

<!-- Single Employee Profile Modal -->
<div class="modal fade" id="employeeProfileModal" tabindex="-1" aria-labelledby="employeeProfileModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg">
		<div class="modal-content">
			<div class="modal-header text-white" style="background-color: #119a48;">
				<div class="d-flex align-items-center w-100">
					<div class="flex-grow-1">
						<h5 class="modal-title mb-0" id="employeeProfileModalLabel">
							<i class="fa fa-user me-2"></i>Employee Profile
						</h5>
					</div>
					<div class="d-flex gap-2">
						<a href="#" id="editProfileBtn" class="btn btn-light btn-sm" data-bs-toggle="modal" onclick="event.preventDefault(); var profileModal = bootstrap.Modal.getInstance(document.getElementById('employeeProfileModal')); if(profileModal) profileModal.hide();">
							<i class="fa fa-edit me-1"></i>Edit
						</a>
						<a href="#" id="printProfileBtn" class="btn btn-light btn-sm" target="_blank">
							<i class="fa fa-print me-1"></i>Print
						</a>
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
				</div>
			</div>
			<div class="modal-body p-4" id="employeeProfileContent">
				<div class="text-center py-5">
					<div class="spinner-border" role="status" style="color: #119a48;">
						<span class="visually-hidden">Loading...</span>
					</div>
					<p class="mt-3 text-muted">Loading employee profile...</p>
				</div>
			</div>
			<div class="modal-footer bg-light">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					<i class="fa fa-times me-1"></i>Close
				</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function openImageModal(imageSrc) {
    document.getElementById("modalImage").src = imageSrc;
    var myModal = new bootstrap.Modal(document.getElementById("imageModal"), {});
    myModal.show();
}

// Employee Profile Modal Handler
$(document).ready(function() {
	var currentStaffId = null;

	// Handle profile link clicks
	$(document).on('click', '.view-staff-profile', function(e) {
		e.preventDefault();
		var staffId = $(this).data('staff-id');
		currentStaffId = staffId;
		
		// Get modal element
		var modalElement = document.getElementById('employeeProfileModal');
		
		// Get or create modal instance
		var modal = bootstrap.Modal.getInstance(modalElement);
		if (!modal) {
			modal = new bootstrap.Modal(modalElement);
		}
		
		// Show modal
		modal.show();
		
		// Load staff data
		loadStaffProfile(staffId);
	});
	
	// Handle modal close events to reset content (only bind once)
	$('#employeeProfileModal').on('hidden.bs.modal', function() {
		$('#employeeProfileContent').html(`
			<div class="text-center py-5">
				<div class="spinner-border" role="status" style="color: #119a48;">
					<span class="visually-hidden">Loading...</span>
				</div>
				<p class="mt-3 text-muted">Loading employee profile...</p>
			</div>
		`);
	});

	function loadStaffProfile(staffId) {
		// Show loading state
		$('#employeeProfileContent').html(`
			<div class="text-center py-5">
				<div class="spinner-border" role="status" style="color: #119a48;">
					<span class="visually-hidden">Loading...</span>
				</div>
				<p class="mt-3 text-muted">Loading employee profile...</p>
			</div>
		`);

		// Fetch staff data
		$.ajax({
			url: '<?php echo base_url(); ?>staff/get_staff_profile_ajax/' + encodeURIComponent(staffId),
			method: 'GET',
			dataType: 'json',
			contentType: 'application/json; charset=utf-8',
			success: function(response) {
				if (response.success) {
					populateModal(response);
				} else {
					$('#employeeProfileContent').html(`
						<div class="alert alert-danger">
							<i class="fa fa-exclamation-triangle me-2"></i>${response.message || 'Failed to load staff profile'}
						</div>
					`);
				}
			},
			error: function(xhr, status, error) {
				console.error('AJAX Error:', status, error);
				console.error('Response:', xhr.responseText);
				$('#employeeProfileContent').html(`
					<div class="alert alert-danger">
						<i class="fa fa-exclamation-triangle me-2"></i>Error loading staff profile. Please try again.
						<br><small>Error: ${error}</small>
					</div>
				`);
			}
		});
	}

	function populateModal(data) {
		var staff = data.staff;
		var contract = data.contract;
		
		// Update edit and print buttons
		$('#editProfileBtn').attr('data-bs-target', '#edit_profile' + staff.staff_id);
		$('#printProfileBtn').attr('href', '<?php echo base_url(); ?>staff/profile/' + staff.staff_id);

		var html = `
			<!-- Header Section with Photo and Name -->
			<div class="row mb-4 pb-3 border-bottom">
				<div class="col-md-3 text-center">
					<div class="mb-3">
						${staff.photo_html || '<div class="bg-secondary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;"><i class="fa fa-user fa-3x text-white"></i></div>'}
					</div>
				</div>
				<div class="col-md-9">
					<h3 class="mb-2" style="color: #119a48;">
						${staff.title ? staff.title + ' ' : ''}${staff.lname} ${staff.fname} ${staff.oname || ''}
					</h3>
					${staff.SAPNO ? `<p class="text-muted mb-1"><i class="fa fa-id-card me-2"></i><strong>SAP Number:</strong> ${staff.SAPNO}</p>` : ''}
					${staff.work_email ? `<p class="text-muted mb-1"><i class="fa fa-envelope me-2"></i><a href="mailto:${staff.work_email}" class="text-decoration-none">${staff.work_email}</a></p>` : ''}
				</div>
			</div>

			<!-- Information Sections -->
			<div class="row g-4">
				<!-- Personal Information -->
				<div class="col-md-6">
					<div class="card h-100 border-0 shadow-sm">
						<div class="card-header bg-light">
							<h5 class="mb-0"><i class="fa fa-user me-2" style="color: #119a48;"></i>Personal Information</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								${staff.gender ? `<div class="col-12"><strong class="text-muted d-block mb-1">Gender</strong><span>${staff.gender}</span></div>` : ''}
								${staff.date_of_birth ? `<div class="col-12"><strong class="text-muted d-block mb-1">Date of Birth</strong><span>${staff.date_of_birth}</span></div>` : ''}
								${staff.nationality ? `<div class="col-12"><strong class="text-muted d-block mb-1">Nationality</strong><span><i class="fa fa-globe me-1"></i>${staff.nationality}</span></div>` : ''}
								${staff.initiation_date ? `<div class="col-12"><strong class="text-muted d-block mb-1">Initiation Date</strong><span>${staff.initiation_date}</span></div>` : ''}
							</div>
						</div>
					</div>
				</div>

				<!-- Contact Information -->
				<div class="col-md-6">
					<div class="card h-100 border-0 shadow-sm">
						<div class="card-header bg-light">
							<h5 class="mb-0"><i class="fa fa-address-book me-2" style="color: #119a48;"></i>Contact Information</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								${staff.work_email ? `<div class="col-12"><strong class="text-muted d-block mb-1">Work Email</strong><span><a href="mailto:${staff.work_email}" class="text-decoration-none">${staff.work_email}</a></span></div>` : ''}
								${staff.tel_1 || staff.tel_2 ? `<div class="col-12"><strong class="text-muted d-block mb-1">Telephone</strong><span><i class="fa fa-phone me-1"></i>${staff.tel_1 || ''}${staff.tel_1 && staff.tel_2 ? ' <span class="text-muted">/</span> ' : ''}${staff.tel_2 || ''}</span></div>` : ''}
								${staff.whatsapp ? `<div class="col-12"><strong class="text-muted d-block mb-1">WhatsApp</strong><span><i class="fab fa-whatsapp me-1 text-success"></i>${staff.whatsapp}</span></div>` : ''}
								${staff.physical_location ? `<div class="col-12"><strong class="text-muted d-block mb-1">Physical Location</strong><span><i class="fa fa-map-marker-alt me-1"></i>${staff.physical_location}</span></div>` : ''}
							</div>
						</div>
					</div>
				</div>

				<!-- Contract Information -->
				<div class="col-12">
					<div class="card border-0 shadow-sm">
						<div class="card-header bg-light d-flex justify-content-between align-items-center">
							<h5 class="mb-0"><i class="fa fa-file-contract me-2" style="color: #119a48;"></i>Current Contract Information</h5>
							<a href="<?php echo base_url(); ?>staff/staff_contracts/${staff.staff_id}" target="_blank" class="btn btn-sm" style="background-color: #119a48; color: white; border-color: #119a48;">
								<i class="fa fa-external-link-alt me-1"></i>Manage Contracts
							</a>
						</div>
						<div class="card-body">
							${contract ? `
								<div class="row g-3">
									${contract.duty_station_name ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Duty Station</strong><span>${contract.duty_station_name}</span></div>` : ''}
									${contract.division_name ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Division</strong><span>${contract.division_name}</span></div>` : ''}
									${contract.job_name ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Job Title</strong><span>${contract.job_name}</span></div>` : ''}
									${contract.job_acting && contract.job_acting != 'N/A' ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Acting Job</strong><span>${contract.job_acting}</span></div>` : ''}
									${contract.first_supervisor ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">First Supervisor</strong><span>${contract.first_supervisor}</span></div>` : ''}
									${contract.second_supervisor ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Second Supervisor</strong><span>${contract.second_supervisor}</span></div>` : ''}
									${contract.funder ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Funder</strong><span>${contract.funder}</span></div>` : ''}
									${contract.contracting_institution ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Contracting Organisation</strong><span>${contract.contracting_institution}</span></div>` : ''}
									${contract.grade ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Grade</strong><span>${contract.grade}</span></div>` : ''}
									${contract.contract_type ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Contract Type</strong><span>${contract.contract_type}</span></div>` : ''}
									${contract.status ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Contract Status</strong><span class="badge bg-${contract.status == 'Active' ? 'success' : (contract.status == 'Expired' ? 'danger' : 'warning')}">${contract.status}</span></div>` : ''}
									${contract.start_date ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">Start Date</strong><span>${contract.start_date}</span></div>` : ''}
									${contract.end_date ? `<div class="col-md-4"><strong class="text-muted d-block mb-1">End Date</strong><span>${contract.end_date}</span></div>` : ''}
									${contract.comments ? `<div class="col-12"><strong class="text-muted d-block mb-1">Comments</strong><span>${contract.comments}</span></div>` : ''}
								</div>
							` : '<p class="text-muted">No contract information available.</p>'}
						</div>
					</div>
				</div>
			</div>
		`;

		$('#employeeProfileContent').html(html);
	}
});
</script>